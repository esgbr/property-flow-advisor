
import React, { createContext, useContext, useState, useEffect } from 'react';
import { useUserPreferences } from './UserPreferencesContext';
import { detectBrowserLanguage, isLanguageSupported, getBestMatchLanguage } from '@/utils/languageDetector';

// Definiere verf√ºgbare Sprachen
export type SupportedLanguage = 'en' | 'de' | 'fr' | 'es' | 'it';

// Sprachinfo-Interface
export interface LanguageInfo {
  code: SupportedLanguage;
  name: string;
  flag: string;
  enabled: boolean;
  nativeName: string;
}

// Verf√ºgbare Sprachen in der Anwendung mit Deutsch als erste Option
export const availableLanguages: LanguageInfo[] = [
  { code: 'de', name: 'German', flag: 'üá©üá™', enabled: true, nativeName: 'Deutsch' },
  { code: 'en', name: 'English', flag: 'üá¨üáß', enabled: true, nativeName: 'English' },
  { code: 'fr', name: 'French', flag: 'üá´üá∑', enabled: true, nativeName: 'Fran√ßais' },
  { code: 'es', name: 'Spanish', flag: 'üá™üá∏', enabled: false, nativeName: 'Espa√±ol' },
  { code: 'it', name: 'Italian', flag: 'üáÆüáπ', enabled: false, nativeName: 'Italiano' }
];

// √úbersetzungsw√∂rterbuch-Typ
type TranslationDictionary = Record<string, Record<string, string>>;

// √úberarbeitete √úbersetzungen
const translationDictionary: TranslationDictionary = {
  // Allgemeine Benutzeroberfl√§che
  propertyFlow: {
    en: 'PropertyFlow',
    de: 'ImmobilienFlow',
    fr: 'PropertyFlow',
    es: 'PropertyFlow',
    it: 'PropertyFlow'
  },
  investmentPlatform: {
    en: 'Real Estate Investment Platform',
    de: 'Immobilien-Investment-Plattform',
    fr: 'Plateforme d\'investissement immobilier',
    es: 'Plataforma de inversi√≥n inmobiliaria',
    it: 'Piattaforma di investimento immobiliare'
  },
  home: {
    en: 'Home',
    de: 'Startseite',
    fr: 'Accueil',
    es: 'Inicio',
    it: 'Home'
  },
  dashboard: {
    en: 'Dashboard',
    de: 'Dashboard',
    fr: 'Tableau de bord',
    es: 'Panel de control',
    it: 'Dashboard'
  },
  settings: {
    en: 'Settings',
    de: 'Einstellungen',
    fr: 'Param√®tres',
    es: 'Configuraci√≥n',
    it: 'Impostazioni'
  },
  language: {
    en: 'Language',
    de: 'Sprache',
    fr: 'Langue',
    es: 'Idioma',
    it: 'Lingua'
  },
  theme: {
    en: 'Theme',
    de: 'Design',
    fr: 'Th√®me',
    es: 'Tema',
    it: 'Tema'
  },
  account: {
    en: 'Account',
    de: 'Konto',
    fr: 'Compte',
    es: 'Cuenta',
    it: 'Account'
  },
  login: {
    en: 'Login',
    de: 'Anmelden',
    fr: 'Connexion',
    es: 'Iniciar sesi√≥n',
    it: 'Accesso'
  },
  logout: {
    en: 'Logout',
    de: 'Abmelden',
    fr: 'D√©connexion',
    es: 'Cerrar sesi√≥n',
    it: 'Disconnettersi'
  },
  register: {
    en: 'Register',
    de: 'Registrieren',
    fr: 'S\'inscrire',
    es: 'Registrarse',
    it: 'Registrarsi'
  },
  
  // Anwendungssperr-Funktionalit√§t
  appLocked: {
    en: 'App Locked',
    de: 'App gesperrt',
    fr: 'Application verrouill√©e',
    es: 'Aplicaci√≥n bloqueada',
    it: 'App bloccata'
  },
  enterPINToUnlock: {
    en: 'Enter your PIN to unlock',
    de: 'Geben Sie Ihre PIN zum Entsperren ein',
    fr: 'Entrez votre code PIN pour d√©verrouiller',
    es: 'Introduzca su PIN para desbloquear',
    it: 'Inserisci il PIN per sbloccare'
  },
  unlock: {
    en: 'Unlock',
    de: 'Entsperren',
    fr: 'D√©verrouiller',
    es: 'Desbloquear',
    it: 'Sblocca'
  },
  useFaceId: {
    en: 'Use Face ID',
    de: 'Face ID verwenden',
    fr: 'Utiliser Face ID',
    es: 'Usar Face ID',
    it: 'Usa Face ID'
  },
  verifying: {
    en: 'Verifying...',
    de: '√úberpr√ºfung...',
    fr: 'V√©rification...',
    es: 'Verificando...',
    it: 'Verifica in corso...'
  },
  appUnlocked: {
    en: 'App Unlocked',
    de: 'App entsperrt',
    fr: 'Application d√©verrouill√©e',
    es: 'Aplicaci√≥n desbloqueada',
    it: 'App sbloccata'
  },
  welcomeBack: {
    en: 'Welcome back!',
    de: 'Willkommen zur√ºck!',
    fr: 'Bienvenue √† nouveau!',
    es: '¬°Bienvenido de nuevo!',
    it: 'Bentornato!'
  },
  invalidPIN: {
    en: 'Invalid PIN',
    de: 'Ung√ºltige PIN',
    fr: 'Code PIN invalide',
    es: 'PIN no v√°lido',
    it: 'PIN non valido'
  },
  faceIdFailed: {
    en: 'Face ID verification failed',
    de: 'Face ID-√úberpr√ºfung fehlgeschlagen',
    fr: 'La v√©rification Face ID a √©chou√©',
    es: 'La verificaci√≥n de Face ID fall√≥',
    it: 'Verifica Face ID fallita'
  },
  
  // Einstellungsseite
  personalizeYourExperience: {
    en: 'Personalize your experience',
    de: 'Personalisieren Sie Ihre Erfahrung',
    fr: 'Personnalisez votre exp√©rience',
    es: 'Personaliza tu experiencia',
    it: 'Personalizza la tua esperienza'
  },
  general: {
    en: 'General',
    de: 'Allgemein',
    fr: 'G√©n√©ral',
    es: 'General',
    it: 'Generale'
  },
  security: {
    en: 'Security',
    de: 'Sicherheit',
    fr: 'S√©curit√©',
    es: 'Seguridad',
    it: 'Sicurezza'
  },
  notifications: {
    en: 'Notifications',
    de: 'Benachrichtigungen',
    fr: 'Notifications',
    es: 'Notificaciones',
    it: 'Notifiche'
  },
  chooseYourTheme: {
    en: 'Choose your preferred theme',
    de: 'W√§hlen Sie Ihr bevorzugtes Design',
    fr: 'Choisissez votre th√®me pr√©f√©r√©',
    es: 'Elige tu tema preferido',
    it: 'Scegli il tuo tema preferito'
  },
  preferences: {
    en: 'Preferences',
    de: 'Pr√§ferenzen',
    fr: 'Pr√©f√©rences',
    es: 'Preferencias',
    it: 'Preferenze'
  },
  userPreferences: {
    en: 'User preferences and settings',
    de: 'Benutzerpr√§ferenzen und Einstellungen',
    fr: 'Pr√©f√©rences et param√®tres utilisateur',
    es: 'Preferencias y configuraci√≥n del usuario',
    it: 'Preferenze e impostazioni utente'
  },
  resetOnboarding: {
    en: 'Reset Onboarding',
    de: 'Einf√ºhrung zur√ºcksetzen',
    fr: 'R√©initialiser l\'int√©gration',
    es: 'Restablecer la incorporaci√≥n',
    it: 'Reimposta l\'onboarding'
  },
  chooseYourLanguage: {
    en: 'Choose your preferred language',
    de: 'W√§hlen Sie Ihre bevorzugte Sprache',
    fr: 'Choisissez votre langue pr√©f√©r√©e',
    es: 'Elige tu idioma preferido',
    it: 'Scegli la tua lingua preferita'
  },
  languageSettings: {
    en: 'Language Settings',
    de: 'Spracheinstellungen',
    fr: 'Param√®tres de langue',
    es: 'Configuraci√≥n de idioma',
    it: 'Impostazioni lingua'
  },
  securitySettings: {
    en: 'Security Settings',
    de: 'Sicherheitseinstellungen',
    fr: 'Param√®tres de s√©curit√©',
    es: 'Configuraci√≥n de seguridad',
    it: 'Impostazioni di sicurezza'
  },
  appLock: {
    en: 'App Lock',
    de: 'App-Sperre',
    fr: 'Verrouillage de l\'application',
    es: 'Bloqueo de aplicaci√≥n',
    it: 'Blocco app'
  },
  appLockEnabled: {
    en: 'App lock is enabled',
    de: 'App-Sperre ist aktiviert',
    fr: 'Le verrouillage de l\'application est activ√©',
    es: 'El bloqueo de la aplicaci√≥n est√° habilitado',
    it: 'Il blocco dell\'app √® abilitato'
  },
  setupPIN: {
    en: 'Set up PIN',
    de: 'PIN einrichten',
    fr: 'Configurer le code PIN',
    es: 'Configurar PIN',
    it: 'Configura PIN'
  },
  passwordStrength: {
    en: 'Password Strength',
    de: 'Passwortst√§rke',
    fr: 'Force du mot de passe',
    es: 'Fuerza de la contrase√±a',
    it: 'Robustezza della password'
  },
  passwordLength: {
    en: 'Password must be at least 8 characters',
    de: 'Passwort muss mindestens 8 Zeichen lang sein',
    fr: 'Le mot de passe doit comporter au moins 8 caract√®res',
    es: 'La contrase√±a debe tener al menos 8 caracteres',
    it: 'La password deve contenere almeno 8 caratteri'
  },
  accountSettings: {
    en: 'Account Settings',
    de: 'Kontoeinstellungen',
    fr: 'Param√®tres du compte',
    es: 'Configuraci√≥n de la cuenta',
    it: 'Impostazioni account'
  },
  user: {
    en: 'User',
    de: 'Benutzer',
    fr: 'Utilisateur',
    es: 'Usuario',
    it: 'Utente'
  },
  updateProfile: {
    en: 'Update Profile',
    de: 'Profil aktualisieren',
    fr: 'Mettre √† jour le profil',
    es: 'Actualizar perfil',
    it: 'Aggiorna profilo'
  },
  notificationPreferences: {
    en: 'Notification Preferences',
    de: 'Benachrichtigungseinstellungen',
    fr: 'Pr√©f√©rences de notification',
    es: 'Preferencias de notificaci√≥n',
    it: 'Preferenze di notifica'
  },
  comingSoon: {
    en: 'Coming Soon',
    de: 'Demn√§chst verf√ºgbar',
    fr: 'Bient√¥t disponible',
    es: 'Pr√≥ximamente',
    it: 'Prossimamente'
  },
  
  // Onboarding
  onboardingStepTitle_welcome: {
    en: 'Welcome to PropertyFlow',
    de: 'Willkommen bei ImmobilienFlow',
    fr: 'Bienvenue sur PropertyFlow',
    es: 'Bienvenido a PropertyFlow',
    it: 'Benvenuto su PropertyFlow'
  },
  onboardingStepDescription_welcome: {
    en: 'Let\'s get to know you better',
    de: 'Lassen Sie uns Sie besser kennenlernen',
    fr: 'Apprenons √† mieux vous conna√Ætre',
    es: 'Vamos a conocerte mejor',
    it: 'Conosciamoci meglio'
  },
  onboardingStepTitle_experience: {
    en: 'Your Experience Level',
    de: 'Ihr Erfahrungsniveau',
    fr: 'Votre niveau d\'exp√©rience',
    es: 'Tu nivel de experiencia',
    it: 'Il tuo livello di esperienza'
  },
  onboardingStepDescription_experience: {
    en: 'Help us tailor the experience to your knowledge level',
    de: 'Helfen Sie uns, die Erfahrung an Ihr Wissensniveau anzupassen',
    fr: 'Aidez-nous √† adapter l\'exp√©rience √† votre niveau de connaissance',
    es: 'Ay√∫danos a adaptar la experiencia a tu nivel de conocimiento',
    it: 'Aiutaci a personalizzare l\'esperienza in base al tuo livello di conoscenza'
  },
  onboardingStepTitle_interests: {
    en: 'Your Interests',
    de: 'Ihre Interessen',
    fr: 'Vos int√©r√™ts',
    es: 'Tus intereses',
    it: 'I tuoi interessi'
  },
  onboardingStepDescription_interests: {
    en: 'What aspects of real estate investing interest you?',
    de: 'Welche Aspekte der Immobilieninvestition interessieren Sie?',
    fr: 'Quels aspects de l\'investissement immobilier vous int√©ressent?',
    es: '¬øQu√© aspectos de la inversi√≥n inmobiliaria te interesan?',
    it: 'Quali aspetti dell\'investimento immobiliare ti interessano?'
  },
  onboardingStepTitle_markets: {
    en: 'Investment Markets',
    de: 'Investmentm√§rkte',
    fr: 'March√©s d\'investissement',
    es: 'Mercados de inversi√≥n',
    it: 'Mercati di investimento'
  },
  onboardingStepDescription_markets: {
    en: 'Which real estate markets are you most interested in?',
    de: 'An welchen Immobilienm√§rkten sind Sie am meisten interessiert?',
    fr: 'Quels march√©s immobiliers vous int√©ressent le plus?',
    es: '¬øEn qu√© mercados inmobiliarios est√°s m√°s interesado?',
    it: 'Quali mercati immobiliari ti interessano di pi√π?'
  },
  onboardingStepTitle_complete: {
    en: 'All Set!',
    de: 'Alles eingerichtet!',
    fr: 'Tout est pr√™t!',
    es: '¬°Todo listo!',
    it: 'Tutto pronto!'
  },
  onboardingStepDescription_complete: {
    en: 'Your personalized experience is ready',
    de: 'Ihre personalisierte Erfahrung ist bereit',
    fr: 'Votre exp√©rience personnalis√©e est pr√™te',
    es: 'Tu experiencia personalizada est√° lista',
    it: 'La tua esperienza personalizzata √® pronta'
  },
  enterYourName: {
    en: 'Enter your name',
    de: 'Geben Sie Ihren Namen ein',
    fr: 'Entrez votre nom',
    es: 'Ingresa tu nombre',
    it: 'Inserisci il tuo nome'
  },
  beginnerInvestor: {
    en: 'Beginner Investor',
    de: 'Anf√§nger-Investor',
    fr: 'Investisseur d√©butant',
    es: 'Inversor principiante',
    it: 'Investitore principiante'
  },
  intermediateInvestor: {
    en: 'Intermediate Investor',
    de: 'Mittlerer Investor',
    fr: 'Investisseur interm√©diaire',
    es: 'Inversor intermedio',
    it: 'Investitore intermedio'
  },
  advancedInvestor: {
    en: 'Advanced Investor',
    de: 'Fortgeschrittener Investor',
    fr: 'Investisseur avanc√©',
    es: 'Inversor avanzado',
    it: 'Investitore avanzato'
  },
  expertInvestor: {
    en: 'Expert Investor',
    de: 'Experten-Investor',
    fr: 'Investisseur expert',
    es: 'Inversor experto',
    it: 'Investitore esperto'
  },
  cashFlow: {
    en: 'Cash Flow',
    de: 'Cashflow',
    fr: 'Flux de tr√©sorerie',
    es: 'Flujo de efectivo',
    it: 'Flusso di cassa'
  },
  appreciation: {
    en: 'Appreciation',
    de: 'Wertsteigerung',
    fr: 'Appr√©ciation',
    es: 'Apreciaci√≥n',
    it: 'Apprezzamento'
  },
  equity: {
    en: 'Equity Building',
    de: 'Eigenkapitalaufbau',
    fr: 'Constitution de fonds propres',
    es: 'Construcci√≥n de capital',
    it: 'Costituzione di capitale proprio'
  },
  tax: {
    en: 'Tax Benefits',
    de: 'Steuervorteile',
    fr: 'Avantages fiscaux',
    es: 'Beneficios fiscales',
    it: 'Vantaggi fiscali'
  },
  germany: {
    en: 'Germany',
    de: 'Deutschland',
    fr: 'Allemagne',
    es: 'Alemania',
    it: 'Germania'
  },
  austria: {
    en: 'Austria',
    de: '√ñsterreich',
    fr: 'Autriche',
    es: 'Austria',
    it: 'Austria'
  },
  switzerland: {
    en: 'Switzerland',
    de: 'Schweiz',
    fr: 'Suisse',
    es: 'Suiza',
    it: 'Svizzera'
  },
  global: {
    en: 'Global Markets',
    de: 'Globale M√§rkte',
    fr: 'March√©s mondiaux',
    es: 'Mercados globales',
    it: 'Mercati globali'
  },
  onboardingComplete: {
    en: 'Your profile has been set up',
    de: 'Ihr Profil wurde eingerichtet',
    fr: 'Votre profil a √©t√© configur√©',
    es: 'Tu perfil ha sido configurado',
    it: 'Il tuo profilo √® stato configurato'
  },
  back: {
    en: 'Back',
    de: 'Zur√ºck',
    fr: 'Retour',
    es: 'Atr√°s',
    it: 'Indietro'
  },
  next: {
    en: 'Next',
    de: 'Weiter',
    fr: 'Suivant',
    es: 'Siguiente',
    it: 'Avanti'
  },
  getStarted: {
    en: 'Get Started',
    de: 'Loslegen',
    fr: 'Commencer',
    es: 'Comenzar',
    it: 'Inizia'
  },
  
  // Barrierefreiheit
  skipToContent: {
    en: 'Skip to content',
    de: 'Zum Inhalt springen',
    fr: 'Passer au contenu',
    es: 'Saltar al contenido',
    it: 'Vai al contenuto'
  },
  
  // Sicherheitshinweise
  securityAlert: {
    en: 'Security Alert',
    de: 'Sicherheitshinweis',
    fr: 'Alerte de s√©curit√©',
    es: 'Alerta de seguridad',
    it: 'Avviso di sicurezza'
  },
  securityAlertDescription: {
    en: 'Your account is not protected with a PIN. Set up a PIN for enhanced security.',
    de: 'Ihr Konto ist nicht mit einer PIN gesch√ºtzt. Richten Sie eine PIN f√ºr erh√∂hte Sicherheit ein.',
    fr: 'Votre compte n\'est pas prot√©g√© par un code PIN. Configurez un code PIN pour une s√©curit√© renforc√©e.',
    es: 'Su cuenta no est√° protegida con un PIN. Configure un PIN para mayor seguridad.',
    it: 'Il tuo account non √® protetto con un PIN. Configura un PIN per una maggiore sicurezza.'
  },
  dismiss: {
    en: 'Dismiss',
    de: 'Ablehnen',
    fr: 'Ignorer',
    es: 'Descartar',
    it: 'Ignora'
  },
  securityEnabled: {
    en: 'Security Enabled',
    de: 'Sicherheit aktiviert',
    fr: 'S√©curit√© activ√©e',
    es: 'Seguridad habilitada',
    it: 'Sicurezza abilitata'
  },
  securityEnabledDescription: {
    en: 'Your app is protected with a PIN lock for enhanced security.',
    de: 'Ihre App ist durch eine PIN-Sperre f√ºr erh√∂hte Sicherheit gesch√ºtzt.',
    fr: 'Votre application est prot√©g√©e par un verrouillage par code PIN pour une s√©curit√© renforc√©e.',
    es: 'Su aplicaci√≥n est√° protegida con un bloqueo PIN para mayor seguridad.',
    it: 'La tua app √® protetta con un blocco PIN per una maggiore sicurezza.'
  },
  error: {
    en: 'Error',
    de: 'Fehler',
    fr: 'Erreur',
    es: 'Error',
    it: 'Errore'
  },
  success: {
    en: 'Success',
    de: 'Erfolg',
    fr: 'Succ√®s',
    es: '√âxito',
    it: 'Successo'
  },
  lock: {
    en: 'Lock',
    de: 'Sperren',
    fr: 'Verrouiller',
    es: 'Bloquear',
    it: 'Blocca'
  },
  lockingApp: {
    en: 'Locking app...',
    de: 'App wird gesperrt...',
    fr: 'Verrouillage de l\'application...',
    es: 'Bloqueando la aplicaci√≥n...',
    it: 'Blocco dell\'app...'
  }
};

// LanguageContext-Interface
interface LanguageContextProps {
  language: SupportedLanguage;
  setLanguage: (language: SupportedLanguage) => void;
  t: (key: string) => string;
  availableLanguages: LanguageInfo[];
  translations: Record<string, Record<string, string>>;
}

// Erstellen des Kontexts mit Standardwerten
const LanguageContext = createContext<LanguageContextProps>({
  language: 'de', // Standardm√§√üig Deutsch
  setLanguage: () => {},
  t: () => '',
  availableLanguages,
  translations: {}
});

// LanguageProvider-Komponente
export const LanguageProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const { preferences, updatePreferences } = useUserPreferences();
  const [language, setLanguage] = useState<SupportedLanguage>('de'); // Standardm√§√üig Deutsch
  
  // Sprachdetektierung beim Laden
  useEffect(() => {
    // Pr√ºfe, ob eine Sprache in den Benutzereinstellungen gespeichert ist
    if (preferences.language) {
      // Stelle sicher, dass es eine unterst√ºtzte Sprache ist
      if (preferences.language === 'en' || 
          preferences.language === 'de' || 
          preferences.language === 'fr' || 
          preferences.language === 'es' || 
          preferences.language === 'it') {
        setLanguage(preferences.language as SupportedLanguage);
      }
    } else {
      // Wenn keine gespeichert ist, erkenne die beste √úbereinstimmung aus dem Browser
      // Priorit√§t f√ºr Deutsch
      const browserLanguage = detectBrowserLanguage();
      if (browserLanguage === 'de') {
        setLanguage('de');
      } else {
        // Fallback auf die beste √úbereinstimmung
        const supportedLanguages = availableLanguages
          .filter(lang => lang.enabled)
          .map(lang => lang.code);
        
        // Priorisiere Deutsch, falls unterst√ºtzt
        if (supportedLanguages.includes('de')) {
          setLanguage('de');
        } else {
          // Ansonsten verwende die beste √úbereinstimmung
          const bestMatch = getBestMatchLanguage(supportedLanguages);
          setLanguage(bestMatch as SupportedLanguage);
        }
      }
    }
  }, [preferences.language]);
  
  // Funktion zum √Ñndern der Sprache
  const handleSetLanguage = (newLanguage: SupportedLanguage) => {
    setLanguage(newLanguage);
    updatePreferences({ language: newLanguage });
    
    // Setze das lang-Attribut auf dem HTML-Element
    document.documentElement.setAttribute('lang', newLanguage);
  };
  
  // Stellen Sie bei der ersten Bereitstellung das HTML-Sprachattribut ein
  useEffect(() => {
    document.documentElement.setAttribute('lang', language);
  }, [language]);
  
  // Funktion zum Abrufen von √úbersetzungen
  const t = (key: string): string => {
    // √úberpr√ºfe, ob der Schl√ºssel existiert
    if (translationDictionary[key] && translationDictionary[key][language]) {
      return translationDictionary[key][language];
    }
    
    // Fallback auf Englisch, wenn √úbersetzung nicht gefunden
    if (translationDictionary[key] && translationDictionary[key]['en']) {
      return translationDictionary[key]['en'];
    }
    
    // Schl√ºssel als Fallback zur√ºckgeben
    return key;
  };
  
  return (
    <LanguageContext.Provider 
      value={{ 
        language, 
        setLanguage: handleSetLanguage, 
        t,
        availableLanguages,
        translations: translationDictionary
      }}
    >
      {children}
    </LanguageContext.Provider>
  );
};

// Hook f√ºr einfachen Zugriff auf den Sprachkontext
export const useLanguage = () => {
  const context = useContext(LanguageContext);
  
  if (context === undefined) {
    throw new Error('useLanguage must be used within a LanguageProvider');
  }
  
  return context;
};

export default LanguageContext;
